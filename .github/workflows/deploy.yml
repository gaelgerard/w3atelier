name: Deploy via GitHub Build (Critical CSS) & Sync

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ WHITELIST (Lancée tôt pour laisser le pare-feu s'ouvrir pendant les installs)
      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Whitelist runner IP on o2switch
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=${{ secrets.SFTP_PORT }}
          echo "Whitelisting IP: $IP on port $PORT"
          
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=$IP&port=$PORT&direction=in" | jq

      # 2️⃣ BUILD DES ASSETS SUR GITHUB (Inclus Critical CSS)
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libnss3 libatk-bridge2.0-0 libgtk-3-0 libx11-xcb1 libxcb-dri3-0 libxss1 libasound2t64 libxtst6 libxshmfence1 libgbm1

      - name: Node Build (Local)
        run: |
          cd ${{ secrets.THEME_DIR }}
          npm install
          npm run build # Ici, GitHub génère le dossier /public/build avec le Critical CSS

      # 3️⃣ PRÉPARATION SSH
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SFTP_PRIVATE_KEY }}

      # 4️⃣ DÉPLOIEMENT : Transfert des fichiers buildés + Git Pull
      - name: Sync and SSH Commands
        run: |
          # Variables de chemins
          LOCAL_BUILD_PATH="${{ secrets.THEME_DIR }}/public/build"
          REMOTE_THEME_PATH="${{ secrets.SFTP_TARGET_DIR }}/${{ secrets.THEME_DIR }}"
          # Nettoyage des slashs
          REMOTE_THEME_PATH=$(echo $REMOTE_THEME_PATH | sed 's#//#/#g')

          echo "Transferring build assets to: $REMOTE_THEME_PATH/public/"

          # Transfert uniquement du dossier build (plus rapide que tout uploader)
          scp -o StrictHostKeyChecking=no -o ConnectTimeout=60 -P ${{ secrets.SFTP_PORT }} -r $LOCAL_BUILD_PATH ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:$REMOTE_THEME_PATH/public/

          # Commandes finales sur le serveur
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=60 -p ${{ secrets.SFTP_PORT }} ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "
            set -e
            cd ${{ secrets.SFTP_TARGET_DIR }}
            
            # Mise à jour du code (PHP/Templates)
            git fetch origin
            git reset --hard origin/main
            
            # Dépendances PHP
            composer install --no-dev --optimize-autoloader
            
            # Nettoyage cache WordPress/Acorn
            wp acorn optimize:clear
          "

      # 5️⃣ CLEANUP
      - name: Remove runner IP from whitelist
        if: always()
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=${{ secrets.SFTP_PORT }}
          echo "Removing GitHub runner IP from whitelist: $IP"

          # IN
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=in" | jq

          # OUT
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=out" | jq