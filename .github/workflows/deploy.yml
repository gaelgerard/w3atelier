name: Deploy via SFTP with temporary o2switch whitelist

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer l’IP publique du runner GitHub
      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      # 2️⃣ Ajouter temporairement l’IP du runner à la whitelist SSH (IN + OUT)
      - name: Whitelist runner IP on o2switch (temporary)
        shell: bash
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=22

          echo "Whitelisting GitHub runner IP: $IP"

          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=$IP&port=$PORT&direction=in" | jq

          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=$IP&port=$PORT&direction=out" | jq

      # 3️⃣ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 4️⃣ Déploiement via rsync / SFTP
      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SFTP_PORT }} -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_TARGET_DIR }}

      # 5️⃣ Cleanup FINAL : suppression de l’IP du runner (IN + OUT)
      - name: Remove runner IP from o2switch whitelist (cleanup)
        if: always()
        shell: bash
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=22

          echo "Removing GitHub runner IP from whitelist: $IP"

          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=in" | jq

          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=out" | jq
