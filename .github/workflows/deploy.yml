name: Deploy via Git Pull & Build Assets with Critical CSS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ INSTALLATION DE CHROME ET DÉPENDANCES (Sur GitHub, pas sur o2switch)
      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev libnss3 libatk-bridge2.0-0 libgtk-3-0 libx11-xcb1 libxcb-dri3-0 libxss1 libasound2 libxtst6 libxshmfence1

      # 2️⃣ BUILD DES ASSETS (Inclus Critical CSS)
      - name: Build Assets
        run: |
          cd ${{ secrets.THEME_DIR }} # Ajustez selon votre structure
          npm install
          npm run build

      # 3️⃣ RÉCUPÉRER L'IP POUR WHITELIST o2switch
      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Whitelist runner IP
        run: |
          # Vos appels curl cPanel actuels ici (identique à votre script)
          # ... (garde le bloc curl IN et OUT)

      # 4️⃣ TRANSFERT DES ASSETS COMPILÉS (Via SCP ou SFTP)
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SFTP_PRIVATE_KEY }}

      - name: Deploy and Sync
        run: |
          # On envoie les fichiers buildés sur le serveur pour qu'ils y soient AVANT le reset
          scp -P ${{ secrets.SFTP_PORT }} -r ${{ secrets.THEME_DIR }}/public/build ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_TARGET_DIR }}/${{ secrets.THEME_DIR }}/public/

          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "
            set -e
            cd ${{ secrets.SFTP_TARGET_DIR }}
            git fetch origin
            git reset --hard origin/main
            
            # Composer à la racine
            composer install --no-dev --optimize-autoloader
            
            # Entrer dans le thème
            cd ${{ secrets.THEME_DIR }}
            composer install --no-dev --optimize-autoloader
            
            # Note : On ne fait plus npm install && build ici ! 
            # Les fichiers sont déjà arrivés via scp.
            
            wp acorn optimize:clear
          "

      # 5️⃣ CLEANUP
      - name: Remove runner IP
        if: always()
        run: |
          # Vos appels curl remove ici