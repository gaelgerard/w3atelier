name: Deploy via Git Pull with temporary o2switch whitelist

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer l’IP publique du runner GitHub
      - name: Get runner public IP
        id: ip
        uses: haythem/public-ip@v1.3

      # 2️⃣ Whitelist temporaire du runner via token cPanel
      - name: Whitelist runner IP on o2switch (temporary)
        shell: bash
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=22

          echo "Whitelisting GitHub runner IP: $IP (IN + OUT)"

          # IN
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=$IP&port=$PORT&direction=in" | jq

          # OUT
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=$IP&port=$PORT&direction=out" | jq

      # 3️⃣ Checkout repository (optionnel si tu as besoin de fichiers locaux)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 4️⃣ Setup SSH agent avec la clé privée GitHub
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SFTP_PRIVATE_KEY }}

      # 5️⃣ Git pull sur le serveur
      - name: Git pull on server
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT }} ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "
            set -e # Arrête le script en cas d'erreur
            
            cd ${{ secrets.SFTP_TARGET_DIR }}
            git fetch origin
            git reset --hard origin/main

            # 1. On s'occupe de la racine (si Bedrock)
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader
            fi

            # 2. On entre dans le thème
            cd ${{ secrets.THEME_DIR }}
            
            # 3. Build PHP (Crucial pour ton erreur "Class not found")
            composer install --no-dev --optimize-autoloader
            
            # 4. Build Assets
            export PATH=\"$PATH:/opt/alt/alt-nodejs22/root/usr/bin/\"
            npm install && npm run build

            # 5. On vide le cache Acorn EN DERNIER
            # On revient à la racine si wp-cli est là-bas, sinon on le lance ici
            wp acorn optimize:clear
          "

      # 6️⃣ Cleanup final : suppression de l’IP du runner de la whitelist
      - name: Remove runner IP from whitelist (cleanup)
        if: always()
        shell: bash
        run: |
          IP="${{ steps.ip.outputs.ipv4 }}"
          PORT=22

          echo "Removing GitHub runner IP from whitelist: $IP"

          # IN
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=in" | jq

          # OUT
          curl -sm 45 -H "Authorization: cpanel ${{ secrets.CPANEL_LOGIN }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove?address=$IP&port=$PORT&direction=out" | jq
